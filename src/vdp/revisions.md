## Revision Summary for VDP Files

The Verilog files in this directory were originally translated from VHDL code, which was extracted from the GitHub project at (https://github.com/lfantoniosi/tn_vdp). This project, in turn, appears to have sourced the VDP V9958 VHDL files from a fork of the MSX OneChip project (possibly from one of these repositories: https://github.com/robinsonb5/OneChipMSX or https://github.com/hra1129/one-chip-msx-kai).

In addition to the translation from VHDL to Verilog, the code has undergone several refactorings and unnecessary code, not required for this implementation, has been removed.

Some key changes include:

### Timing Syncing

The internal generation of timing between the VDP V9958 has been removed. Previously, the module would generate a CX, CY based on the supplied clock as it cycled through the screen image generation, requiring the external HDMI to synchronize with this module. Now, the CX, CY are externally generated by the HDMI module and fed into this module.

### Analogue RGB Generation Removed

The original implementation supported two types of output: Original RGB at 15Khz and VGA with line doubling to 31Khz. The current implementation only supports the 'VGA' mode, which is compatible with standard HDMI/DVI signals.

### VRAM Interleaving

The original implementation mapped the VRAM into the FPGA's SDRAM 16bit wide data bus.  That is for one specific address, a full 16 bit is retrieved.  See the section below under sprite.vhd for original implementation notes.

The SDRAM module exposes a 16bit data bus. As the VDP uses an 8 bit data model,
the 16bits are split into 2 bytes. Previously, the state of A16 address bit
would be use to select either the high or low byte from the single addressed word.  This is the interleaving described in the original implementation

So original logical byte order was:

| Logical Order  | VRAM Addr | VRAM Addr |
|----------------|-----------|-----------|
| 1st 16bit word | 0x00000   | 0x10000   |
| 2nd 16bit word | 0x00001   | 0x00001   |
| .... | ... | ... |

Then, the within the implementation of Graphics mode 6 and 7, this would be 'reversed'.  It would swap A16 with A0.  Thus returning the addressing to a linear order.

I am not sure that it is necessary to have the interleaving.  I have simplified it with commit #f8e97309ce6493543e80adaa5dc61a1da12e964e

This has now been changed to a more conventional ordering.

| Logical Order  | VRAM Addr | VRAM Addr |
|----------------|-----------|-----------|
| 1st 16bit word | 0x00000   | 0x00001   |
| 2nd 16bit word | 0x00002   | 0x00003   |
| .... | ... | ... |


> Graphics 6 and 7 seems to use the double byte retrieval for its YJK colouring decoding.  This is where 2x2 pixels have separate chroma component and a single colour component.

> Further investigation may indicate reasons I have not appreciated and so this commit may need to be 'reverted'

### Original Comments

As the files have significantly change, the header change log in each file has become .. 'confusing'.  So they are reproduced here with much thanks to the original developers.

#### vdp_colordev.vhd
```
// Revision History
//
//  21st,March,2008
//      JP: VDP.VHD から分離 by t.hara
//      (Extracted from VDP.VHD by t.hara)
//
//  22nd,March,2008
//      JP: 不要な信号間の相関を除去 by t.hara
//      (Removed unnecessary signal correlation by t.hara)
//
```

#### vdp_command.vhd

```
//  20th,March,2008
//      JP: VDP.VHD から分離 by t.hara
//      Translation: VDP.VHD extracted by t.hara
```

#### vdp_doublebuf.vhd

```
// JP: ダブルバッファリング機能付きラインバッファモジュール。
// JP: vga.vhdによるアップスキャンコンバートに使用します。
//
// JP: xPositionWに X座標を入れ，weを 1にすると書き込みバッファに
// JP: 書き込まれる．また，xPositionRに X座標を入れると，読み込み
// JP: バッファから読み出した色コードが qから出力される。
// JP: evenOdd信号によって，読み込みバッファと書き込みバッファが
// JP: 切り替わる。
```

#### vdp_graphic123M.vhd

```
// Revision History
//
// 12th,August,2006 created by Kunihiko Ohnaka
// JP: VDPのコアの実装とスクリーンモードの実装を分離した
//
// 29th,October,2006 modified by Kunihiko Ohnaka
//   - Insert the license text.
//   - Add the document part below.
//
// 16th, March, 2008 Refactoring by t.hara
// JP: リファクタリング, VDP_PACKAGE の参照を削除
// (Refactoring, Remove the reference to VDP_PACKAGE)
//
// Document
//
// JP: GRAPHICモード1,2,3および MULTICOLORモードのメイン処理回路です。
// (This is the main processing circuit of GRAPHIC mode 1,2,3 and MULTICOLOR mode.)
//
```

#### vdp_graphic4567.vhd

```
// 12th,August,2006 created by Kunihiko Ohnaka
// JP: VDPのコアの実装とスクリーンモードの実装を分離した
// (Extracted the implementation of the VDP core and the implementation of the screen mode)
//
// 29th,October,2006 modified by Kunihiko Ohnaka
//   - Insert the license text.
//   - Add the document part below.
//
// 20th,March,2008 modified by t.hara
// JP: リファクタリング, VDP_PACKAGE の参照を削除
// (Refactoring, removed the reference to VDP_PACKAGE)
//
// 9th,April,2008 modified by t.hara
// Supported YJK mode.
//
// 11th,September,2019 modified by Oduvaldo Pavan Junior
// Fixed the lack of page flipping (R13) capability
//
// Added the undocumented feature where R1 bit #2 change the blink counter
// clock source from VSYNC to HSYNC
//
// 19th,July,2022 modified by t.hara
// Changed W_B_YJKP from rounding down to rounding up.
// Document
//
// JP: GRAPHICモード4,5,6,7のメイン処理回路です。
// (Main processing circuit of GRAPHIC mode 4,5,6,7.)
/
```

#### vdp_linebuf.vhd

```
// Revision History
//
// 29th,October,2006 modified by Kunihiko Ohnaka
//   - Insert the license text.
//   - Add the document part below.
//
// 21st,March,2008 modified by t.hara
//   JP: リファクタリング, 桁揃えなど些細な修正。
//   (Refactoring, minor fixes such as alignment.)
//
// Document
//
// JP: NTSCタイミングの 15kHzで出力されるビデオ信号をVGAタイミングに
// JP: 合わせた31kHzの倍レートで出力するためのラインバッファモジュール
// JP: です。
// JP: ESE-VDPのメインクロックである21.477MHzで動作させるため、
// JP: ドットクロックは一般的な 640x480ドットVGAモードの25.175MHz
// JP: とは異なります。そのため、液晶モニタ等で表示させるとドットの形が
// JP: いびつな形になる事があります。
// (Convert NTSC timing 15kHz video signal to VGA timing.)
// (This is a line buffer module to convert NTSC timing 15kHz video)
// (signal to VGA timing 31kHz.)
// (This module is designed to operate at 21.477MHz, which is the)
// (dot clock of the general 640x480 dot VGA mode is 25.175MHz.)
// (Therefore, the shape of the dot is distorted when displayed on)
// (an LCD monitor, etc.)
```

#### vdp_register.vhd

```
// Revision History
//
//  23rd,March,2008
//      JP: vdp.vhd から分離 by t.hara
//      (Extracted from vdp.vhd by t.hara")
//
//  28th,March,2008
//      added "S#0 bit6 5th sprite (9th sprite) flag support" by t.hara
//
//  29th,March,2008
//      added V9958 registers (R25,R26,R27) by t.hara
//
//  26th,January,2017
//      patch yuukun status R0 S#5 timing
//
//  5th,September,2019 modified by Oduvaldo Pavan Junior
//      Fixed the lack of page flipping (R13) capability
//
//      Added the undocumented feature where R1 bit #2 change the blink counter
//      clock source from VSYNC to HSYNC
//
//  30th,May,2021 by t.hara
//      In the register writing by address auto-increment mode,
//      the bug that the address is incremented even if it exceeds R#47 is corrected.
//
//  2nd,June,2021 by t.hara
//      Fixed behavior of address auto-increment.
//      Fixed the write operation to the invalid register.
```

#### vdp_sprite.vhd

```
// Revision History
//
// 29th,October,2006 modified by Kunihiko Ohnaka
//   - Insert the license text.
//   - Add the document part below.
//
// 26th,August,2006 modified by Kunihiko Ohnaka
//   - latch the base addresses every eight dot cycle
//     (DRAM RAS/CAS access emulation)
//
// 20th,August,2006 modified by Kunihiko Ohnaka
//   - Change the drawing algorithm.
//   - Add sprite collision checking function.
//   - Add sprite over-mapped checking function.
//   - Many bugs are fixed, and it works fine.
//   - (first release virsion)
//
// 17th,August,2004 created by Kunihiko Ohnaka
//   - Start new sprite module implementing.
//     * This module uses Block RAMs so that shrink the
//       circuit size.
//     * Separate sprite module from vdp.vhd.
//
//---------------------------------------------------------------------------
// Document
//
// JP: この実装ではBLOCKRAMを使い、消費するSLICEを節約するのが狙い。
// JP: この実装を使わない状態での vdp.vhdをコンパイルした時の
// JP: SLICE使用数は1900前後。
// JP: 2006/8/16。このスプライトを使わない最新版(Cyclone)では、
// JP:            2726LCだった.
// JP: 2006/8/19。このスプライトを使ったところ、2278LCまで減少。
// JP:
// JP: [用語]
// JP: ・ローカルプレーン番号
// JP:   あるライン上に並んでいるスプライト(プレーン)だけを抜き出して
// JP:   スプライトプレーン番号順に並べた時の順位。
// JP:   例えばあるラインにスプライトプレーン#1,#4,#5が存在する場合、
// JP:   それぞれのスプライトのローカルプレーン番号は#0,#1,#2となる。
// JP:   スプライトモード2でも横一列に最大8枚しか並ばないので、
// JP:   ローカルプレーン番号は最大で#7となる。
// JP:
// JP: ・画面描画帯域
// JP:    VDPの実機は8ドット(32クロック)で連続アドレス上のデータ4バイト
// JP:    (GRAPHIC6,7ではRAMのインターリーブアクセスによりバイト)
// JP:    のリードに加え、ランダムアドレスへの2サイクル(2バイト)の
// JP:    アクセスが加納
// JP:    それらのDRAMアクセスサイクルに以下のように名前を付ける。
// JP:     * 画面描画リードサイクル
// JP:     * スプライトY座標検査サイクル
// JP:     * ランダムアクセスサイクル
// JP:
// JP: ○似非VDPでのVRAMアクセスサイクル
// JP:    似非VDPでは旧式のDRAMではなくより高速なメモリを使用している。
// JP:    そのため、４クロックに1回確実にランダムアクセスを実行できる
// JP:    メモリを持っている事を前提としてコーディングします。
// JP:    また、Cyclone版似非MSXでは、16ビット幅のSDRAMを用いている
// JP:    ため、一回のアクセスで連続する16ビットのデータを読む事も可能
// JP:    です。
// JP:    似非VDPでは、D0～D7の下位8ビットをVRAMの前半64Kバイト、
// JP:    D8～D15の上位8ビットを後半64Kバイトにマッピングしています。
// JP:    このような変則的な割り当てをするのは、実機のVDPのメモリ
// JP:    マップをまねるためです。実際、4クロックで2バイトのメモリを
// JP:    読み出す帯域が必要になるのはGRAPHIC6,7のモードだけです。
// JP:    実機のVDPは、GRAPHIC6,7ではメモリのインターリーブを用い、
// JP:    (GRAPHIC7における)偶数ドットをVRAMの前半64Kバイトに
// JP:    わりあて、奇数ドットを後半64Kバイトに割り当てています。
// JP:    そのため、似非VDPでも前半64Kと後半64Kの同一アドレス上の
// JP:    データを１サイクル(4クロック)で読み出せる必要があるので
// JP:    このようなマッピングになっています。
// JP:    単純に言えば、SDRAMの16ビットアクセスを、実機のDRAMの
// JP:    インターリーブアクセスに見立てているということです。
// JP:
// JP:    いろいろな現象から、VDPの内部は8ドットサイクルで動いていると
// JP:    推測されています。8ドット、つまり32クロックのどうさをメモリ
// JP:    の帯域から推測すると、以下のようになります。
// JP:
// JP:   　　ドット　：<=0=><=1=><=2=><=3=><=4=><=5=><=6=><=7=>
// JP:   通常アクセス： A0   A1   A2   A3   A4  (A5)  A6  (A7)
// JP: インターリーブ： B0   B1   B2   B3
// JP:
// JP:    - 描画中
// JP:   　　・A0～A3 (B0～B3)
// JP:        画面描画のために使用。B0～B3はインターリーブで同時に
// JP:        読み出せるデータで、GRAPHIC6,7でしか使わない。
// JP:   　　・A4     スプライトY座標検査
// JP:   　　・A6     VRAM R/W or VDPコマンド (2回に一回ずつ、交互に割り当てる)
// JP:
// JP:     - 非描画中(スプライト準備中)
// JP:    　　・A0     スプライトX座標リード
// JP:    　　・A1     スプライトパターン番号リード
// JP:    　　・A2     スプライトパターン左リード
// JP:    　　・A3     スプライトパターン右リード
// JP:    　　・A4     スプライトカラーリード
// JP:    　　・A6     VRAM R/W or VDPコマンド (2回に一回ずつ、交互に割り当てる)
// JP:
// JP:   A5とA7のスロットは実際には使用することもできるのですが、
// JP:   これを使ってしまうと実機よりも帯域が増えてしまうので、
// JP:   あえて使わずに残しています。
// JP:   また、非描画中のサイクルは、実機とは異なります。実機では
// JP:   64クロックで 2つのスプライトをまとめて処理する事で、DRAMの
// JP:   ページモードサイクルを有効利用できるようにしています。
// JP:   また、その64クロックの中にはVRAMやVDPコマンドに割くための
// JP:   スロットが無いので、64クロックサイクルの隙間にVRAMアク
// JP:   セスのための隙間を空けているのかもしれません。（未確認）
// JP:   似非VDPでもその動作を完全に真似する事は可能ですが、
// JP:   ソースが必要以上に複雑に見えてしまうのと、2のn乗サイクル
// JP:   からずれてしまうのがちょっぴり嫌だったので、上記のような
// JP:   きれいなサイクルにしています。
// JP:   どうしても実機と同じタイミングにしたいという方は
// JP:   チャレンジしてみてください。
// JP:
// Translation:
// The aim of this implementation is to use BLOCKRAM and save SLICE consumption.
// The number of SLICEs used when compiling vdp.vhd without this implementation is around 1900.
// As of 2006/8/16, the latest version (Cyclone) without this sprite was 2726LC.
// As of 2006/8/19, using this sprite reduced it to 2278LC.
//
// [Terms]
// ・Local plane number
//   The rank when the sprites (planes) lined up on a certain line are extracted and arranged in the order of sprite plane numbers.
//   For example, if sprite planes #1, #4, and #5 exist on a certain line, the local plane numbers of each sprite are #0, #1, and #2.
//   Even in sprite mode 2, a maximum of 8 can be lined up horizontally, so the local plane number is a maximum of #7.
//
// ・Screen drawing bandwidth
//   The actual VDP machine adds 2 cycles (2 bytes) of access to random addresses in addition to reading 4 bytes of data on continuous addresses at 8 dots (32 clocks).
//   These DRAM access cycles are named as follows.
//    * Screen drawing read cycle
//    * Sprite Y coordinate inspection cycle
//    * Random access cycle
//
// ・VRAM access cycle in pseudo VDP
//   Pseudo VDP uses faster memory than old DRAM.
//   Therefore, it is coded on the assumption that it has memory that can perform random access reliably once every 4 clocks.
//   In addition, in the Cyclone version of pseudo MSX, 16-bit wide SDRAM is used, so it is also possible to read 16 bits of continuous data at one access.
//   In pseudo VDP, the lower 8 bits of D0-D7 are mapped to the first half of 64K bytes of VRAM, and the upper 8 bits of D8-D15 are mapped to the second half of 64K bytes.
//   This irregular assignment is to mimic the memory map of the actual VDP machine. In fact, the bandwidth required to read 2 bytes of memory in 4 clocks is only in GRAPHIC6,7 mode.
//   The actual VDP machine uses memory interleaving in GRAPHIC6,7, assigning even dots to the first half of 64K bytes of VRAM and odd dots to the second half of 64K bytes.
//   Therefore, in pseudo VDP, it is necessary to be able to read data on the same address in the first half of 64K and the second half of 64K in one cycle (4 clocks), so it is mapped like this.
//   Simply put, it is likening the 16-bit access of SDRAM to the interleaved access of the actual DRAM.
//
//   From various phenomena, it is inferred that the inside of the VDP is operating in an 8-dot cycle. If you infer the movement of memory from the bandwidth of 8 dots, or 32 clocks, it will be as follows.
//
//   　　      Dot：<=0=><=1=><=2=><=3=><=4=><=5=><=6=><=7=>
//   Normal Access： A0   A1   A2   A3   A4  (A5)  A6  (A7)
//      Interleave： B0   B1   B2   B3
//
//    - During drawing
//   　　・A0～A3 (B0～B3)
//        Used for screen drawing. B0-B3 is data that can be read at the same time by interleaving, and is not used except in GRAPHIC6,7.
//   　　・A4     Sprite Y coordinate inspection
//   　　・A6     VRAM R/W or VDP command (allocated alternately once every 2 times)
//
//     - Non-drawing (during sprite preparation)
//    　　・A0     Sprite X coordinate read
//    　　・A1     Sprite pattern number read
//    　　・A2     Sprite pattern left read
//    　　・A3     Sprite pattern right read
//    　　・A4     Sprite color read
//    　　・A6     VRAM R/W or VDP command (allocated alternately once every 2 times)
//
//   Although the slots of A5 and A7 can actually be used, if you use this, the bandwidth will increase more than the actual machine, so it is intentionally left unused.
//   Also, the cycle during non-drawing is different from the actual machine. The actual machine processes 2 sprites together in 64 clocks to effectively use the page mode cycle of DRAM.
//   Also, there are no slots to allocate to VRAM and VDP commands in the 64 clock cycle, so it may be leaving a gap for VRAM access in the gap of the 64 clock cycle. (Unconfirmed)
//   It is possible to completely mimic this operation in pseudo VDP, but the source looks unnecessarily complicated, and it was a little annoying to deviate from the 2^n power cycle, so it has a clean cycle as described above.
//   If you want to have the same timing as the actual machine, please challenge.
//
```

#### vdp_ssg.vhd

```
// Revision History
//
//  30th,March,2008
//  JP: VDP.VHD から分離 by t.hara
//  (Extracted from by t.hara)
```

#### vdp_text12.vhd

```
// Contributors
//
//   Alex Wulms
//     - Improvement of the TEXT2 mode such as 'blink function'.
//
//-----------------------------------------------------------------------------
// Revision History
//
// 29th,October,2006 modified by Kunihiko Ohnaka
//   - Insert the license text.
//   - Add the document part below.
//
// 12th,August,2006 created by Kunihiko Ohnaka
// JP: VDPのコアの実装とスクリーンモードの実装を分離した
// (Extracted the VDP core implementation and the screen mode implementation)
//
// 13th,March,2008
// Fixed Blink by caro
//
// 22nd,March,2008
// JP: タイミング緩和と、リファクタリング by t.hara
// (Timing relaxation and refactoring by t.hara)
//
// 11th,September,2019 modified by Oduvaldo Pavan Junior
// Fixed the lack of page flipping (R13) capability
//
// Added the undocumented feature where R1 bit #2 change the blink counter
// clock source from VSYNC to HSYNC
//
//-----------------------------------------------------------------------------
// Document
//
// JP: TEXTモード1,2のメイン処理回路です。
// Main processing circuit of TEXT mode 1, 2.
//
//-----------------------------------------------------------------------------
```

#### vdp_vga.vhd

```
// Revision History
//
// 3rd,June,2018 modified by KdL
//  - Added a trick to help set a pixel ratio 1:1
//    on an LED display at 60Hz (not guaranteed on all displays)
//
// 29th,October,2006 modified by Kunihiko Ohnaka
//  - Inserted the license text
//  - Added the document part below
//
// ??th,August,2006 modified by Kunihiko Ohnaka
//  - Moved the equalization pulse generator from vdp.vhd
//
// 20th,August,2006 modified by Kunihiko Ohnaka
//  - Changed field mapping algorithm when interlace mode is enabled
//        even field  -> even line (odd  line is black)
//        odd  field  -> odd line  (even line is black)
//
// 13th,October,2003 created by Kunihiko Ohnaka
// JP: VDPのコアの実装と表示デバイスへの出力を別ソースにした．
// (Extracted the implementation of the VDP core and the output to the display device.)
//
//-----------------------------------------------------------------------------
// Document
//
// JP: ESE-VDPコア(vdp.vhd)が生成したビデオ信号を、VGAタイミングに
// JP: 変換するアップスキャンコンバータです。
// JP: NTSCは水平同期周波数が15.7kHz、垂直同期周波数が60Hzですが、
// JP: VGAの水平同期周波数は31.5kHz、垂直同期周波数は60Hzであり、
// JP: ライン数だけがほぼ倍になったようなタイミングになります。
// JP: そこで、vdpを ntscモードで動かし、各ラインを倍の速度で
// JP: 二度描画することでスキャンコンバートを実現しています。
// Translation:
//   The video signal generated by the ESE-VDP core vdp.vhd
//   is converted to VGA timing by this up-scan converter.
//   NTSC has a horizontal sync frequency of 15.7kHz and a vertical sync frequency of 60Hz,
//   the horizontal sync frequency of VGA is 31.5kHz and the vertical sync frequency is 60Hz,
//   so the timing is almost doubled in the number of lines.
//   Therefore, the vdp is operated in ntsc mode, and each line is
//   realized by drawing twice at double speed.
```

#### vdp_wait_control.vhd

```
// Revision History
//
// 2nd,Jun,2021 modified by KdL
//  - LMMV is reverted to previous speed in accordance with current VDP module
//
// 9th,Jan,2020 modified by KdL
//  - LMMV fix which improves the Sunrise logo a bit (temporary solution?)
//    Some glitches appear to be unrelated to the VDP_COMMAND entity and
//    the correct speed is not yet reached
//
// 20th,May,2019 modified by KdL
//  - Optimization of speed parameters for greater game compatibility
//
// 14th,May,2018 modified by KdL
//  - Improved the speed accuracy of SRCH, LINE, LMMV, LMMM, HMMV, HMMM and YMMM
//  - Guidelines at http://map.grauw.nl/articles/vdp_commands_speed.php
//
//  - Some evaluation tests:
//    - overall duration of the SPACE MANBOW game intro at 3.58MHz
//    - uncorrupted music in the FRAY game intro at 3.58MHz, 5.37MHz and 8.06MHz
//    - amount of artifacts in the BREAKER game at 5.37MHz
//
```

#### vdp.vhd

```
//-----------------------------------------------------------------------------
// Contributors
//
//   Kazuhiro Tsujikawa
//     - Bug fixes
//   Alex Wulms
//     - Bug fixes
//     - Expansion and improvement of the VDP-Command engine
//     - Improvement of the TEXT2 mode.
//
//-----------------------------------------------------------------------------
// Revision History
//
// 3rd,June,2018 modified by KdL
//  - Improved the VGA up-scan converter
//
// 15th,March,2017 modified by KdL
//  - Improved ENAHSYNC, thanks to Grauw
//
// 27th,July,2014 modified by KdL
//  - Fixed H-SYNC interrupt reset control
//
// 23rd,January,2013 modified by KdL
//  - Fixed V-SYNC and H-SYNC interrupt
//  - Added an extra signal to force NTSC/PAL modes
//
// 29th,October,2006 modified by Kunihiko Ohnaka
//  - Added the license text
//  - Added the document part below
//
// 3rd,Sep,2006 modified by Kunihiko Ohnaka
//  - Fix several UNKNOWN REALITY problems
//  - Horizontal Sprite problem
//  - Overscan problem
//  - [NOP] zoom demo problem
//  - 'Star Wars Scroll' demo problem
//
// 20th,Aug,2006 modified by Kunihiko Ohnaka
//  - Separate SPRITE module
//  - Fixed the palette rewriting timing problem
//  - Added the interlace double resolution function (two page mode)
//
// 15th,Aug,2006 modified by Kunihiko Ohnaka
//  - Separate VDP_NTSC sync generator module
//  - Separate screen mode modules
//  - Fixed the sprite posision problem on GRAPHIC6
//
// 15th,Jan,2006 modified by Alex Wulms
// text 2 mode  : debug blink function
// high-res modi: debug 'screen off'
// text 1&2 mode: debug VdpR23 scroll and color "0000" handling
// all modi     : precalculate adjustx, adjusty once per line
// 1st,Jan,2006 modified by Alex Wulms
// Added the blink support to text 2 mode
//
// 16th,Aug,2005 modified by Kazuhiro Tsujikawa
// JP: TMS9918モードでVRAMインクリメントを下位14ビットに限定
// (Limited VRAM increment to lower 14 bits in TMS9918 mode)
//
// 8th,May,2005 modified by Kunihiko Ohnaka
// JP: VGAコンポーネントにInerlaceMode信号を伝えるようにした
// (Added InerlaceMode signal to VGA component)
//
// 26th,April,2005 modified by Kazuhiro Tsujikawa
// JP: VRAMとのデータバス(pRamDbi/pRamDbo)を単方向バス化(SDRAM対応)
// (Made the data bus to VRAM (pRamDbi/pRamDbo) unidirectional (for SDRAM))
//
// 8th,November,2004 modified by Kazuhiro Tsujikawa
// JP: Vsync/Hsync割り込み修正ミス訂正
// (Fixed a bug in Vsync/Hsync interrupt)
//
// 3rd,November,2004 modified by Kazuhiro Tsujikawa
// JP: SCREEN6画面周辺色修正→MSX2タイトルロゴ対応
// (Fixed the border color of SCREEN6)
//
// 19th,September,2004 modified by Kazuhiro Tsujikawa
// JP: パターンネームテーブルのマスクを実装→ANMAデモ対応
// (Implemented the mask of the pattern name table)
// JP: MultiColorMode(SCREEN3)実装→マジラビデモ対応
// (Implemented MultiColorMode(SCREEN3))
//
// 12th,September,2004 modified by Kazuhiro Tsujikawa
// JP: VdpR0DispNum等をライン単位で反映→スペースマンボウでのチラツキ対策
// (Reflected VdpR0DispNum etc. on a line-by-line basis)
//
// 11th,September,2004 modified by Kazuhiro Tsujikawa
// JP: 水平帰線割り込み修正→MGSEL(テンポ早送り)対策
// (Fixed horizontal retrace interrupt)
//
// 22nd,August,2004 modified by Kazuhiro Tsujikawa
// JP: パレットのRead/Write衝突を修正→ガゼルでのチラツキ対策
// (Fixed the Read/Write conflict of the palette)
//
// 21st,August,2004 modified by Kazuhiro Tsujikawa
// JP: R1/IE0(垂直帰線割り込み許可)の動作を修正→GALAGA対策
// (Fixed the operation of R1/IE0 (vertical retrace interrupt permission))
//
// 2nd,August,2004 modified by Kazuhiro Tsujikawa
// JP: Screen7/8でのスプライト読み込みアドレスを修正→Snatcher対策
// (Fixed the sprite read address in Screen7/8)
//
// 31st,July,2004 modified by Kazuhiro Tsujikawa
// JP: Screen7/8でのVRAM読み込みアドレスを修正→Snatcher対策
// (Fixed the VRAM read address in Screen7/8)
//
// 24th,July,2004 modified by Kazuhiro Tsujikawa
// JP: スプライト32枚同時表示時の乱れを修正(248=256-8->preDotCounter_x_end)
// (Fixed the disorder when displaying 32 sprites at the same time)
//
// 18th,July,2004 modified by Kazuhiro Tsujikawa
// JP: Screen6のレンダリング部を作成
// (Created the rendering part of Screen6)
//
// 17th,July,2004 modified by Kazuhiro Tsujikawa
// JP: Screen7のレンダリング部を作成
// (Created the rendering part of Screen7)
//
// 29th,June,2004 modified by Kazuhiro Tsujikawa
// JP: Screen8のレンダリング部を修正
// (Fixed the rendering part of Screen8)
//
// 26th,June,2004 modified by Kazuhiro Tsujikawa
// JP: WebPackでコンパイルするとHMMC/LMMC/LMCMが動作しない不具合を修正
// (Fixed a bug that HMMC/LMMC/LMCM does not work when compiled with WebPack)
// JP: onehot sequencer(VdpCmdState) must be initialized by asyncronus RESET
//
// 22nd,June,2004 modified by Kazuhiro Tsujikawa
// JP: R1/IE0(垂直帰線割り込み許可)の動作を修正
// (Fixed the operation of R1/IE0 (vertical retrace interrupt permission))
// JP: Ys2でバノアの家に入れる様になった
// (Now you can enter the house of Banjo in Ys2)
//
// 13th,June,2004 modified by Kazuhiro Tsujikawa
// JP: 拡大スプライトが右に1ドットずれる不具合を修正
// (Fixed a bug that the enlarged sprite is shifted by 1 dot to the right)
// JP: SCREEN5でスプライト右端32ドットが表示されない不具合を修正
// (Fixed a bug that the rightmost 32 dots of the sprite are not displayed in SCREEN5)
// JP: SCREEN5で211ライン(最下)のスプライトが表示されない不具合を修正
// (Fixed a bug that the sprite on line 211 (bottom) is not displayed in SCREEN5)
// JP: 画面消去フラグ(VdpR1DispOn)を1ライン単位で反映する様に修正
// (Fixed to reflect the screen erase flag (VdpR1DispOn) on a line-by-line basis)
//
// 21st,March,2004 modified by Alex Wulms
// Several enhancements to command engine:
//   Added PSET,LINE,SRCH,POINT
//   Added the screen 6,7,8 support
//   Improved the existing commands
//
// 15th,January,2004 modified by Kunihiko Ohnaka
// JP: VDPコマンドの実装を開始
// (Started the implementation of the VDP command)
// JP: HMMC,HMMM,YMMM,HMMV,LMMC,LMMM,LMMVを実装.まだ不具合あり.
// (Implemented HMMC,HMMM,YMMM,HMMV,LMMC,LMMM,LMMV. Still has bugs.)
//
// 12th,January,2004 modified by Kunihiko Ohnaka
// JP: コメントの修正
// (Fixed comments)
//
// 30th,December,2003 modified by Kazuhiro Tsujikawa
// JP: 起動時の画面モードをVDP_NTSCと VGAのどちらにするかを，外部入力で切替
// (Switch the startup screen mode to VDP_NTSC or VGA with an external input)
// JP: DHClk/DLClkを一時的に復活させた
// (Temporarily revived DHClk/DLClk)
//
// 16th,December,2003 modified by Kunihiko Ohnaka
// JP: 起動時の画面モードをVDP_NTSCと VGAのどちらにするかを，vdp_package.vhd
// (Switch the startup screen mode to VDP_NTSC or VGA with vdp_package.vhd)
// JP: 内で定義された定数で切替えるようにした．
// (Switch with the constants defined in vdp_package.vhd)
//
// 10th,December,2003 modified by Kunihiko Ohnaka
// JP: TEXT MODE 2 (SCREEN0 WIDTH80)をサポート．
// JP: 初の横方向倍解像度モードである．一応将来対応できるように作って
// JP: きたつもりだったが，少し収まりが悪い部分があり，あまりきれいな
// JP: 対応になっていない部分もあります．
// (Support for TEXT MODE 2 (SCREEN0 WIDTH80))
// (This is the first mode with double horizontal resolution. I intended to make it compatible for the future,)
// (but there are some parts that don't fit well, and some parts that are not very clean.)
//
// 13th,October,2003 modified by Kunihiko Ohnaka
// JP: ESE-MSX基板では 2S300Eを複数用いる事ができるようにり，VDP単体で
// JP: 2S300Eや SRAMを占有する事が可能となった．
// JP: これに伴い以下のような変更を行う．
// JP: ・VGA出力対応(アップスキャンコンバート)
// JP: ・SCREEN7,8のタイミングを実機と同じに
// (With the ESE-MSX board, it is possible to use multiple 2S300Es and the VDP can occupy the 2S300E and SRAM.)
// (With this, the following changes are made:)
// (・Support for VGA output (upscan convert))
// (・The timing of SCREEN7,8 is the same as the actual machine)
//
// 15th,June,2003 modified by Kunihiko Ohnaka
// JP:水平帰線期間割り込みを実装してスペースマンボウを遊べるようにした．
// JP:GraphicMode3(Screen4)でYライン数が 212ラインにならなかったのを
// JP:修正したりした．
// JP:ただし，スペースマンボウで set adjust機能が動いていないような
// JP:感じで，表示がガクガクしてしまう．横方向の同時表示スプライト数も
// JP:足りていないように見える．原因不明．
// (Implemented horizontal retrace interrupt to make Spaceman Bow playable.)
// (Fixed the issue where the number of Y lines in GraphicMode3 (Screen4) did not become 212 lines.)
// (However, it seems that the set adjust function is not working in Spaceman Bow,)
// (and the display is jittery. It also seems that there are not enough sprites displayed simultaneously in the horizontal direction. Cause unknown.)
//
// 15th,June,2003 modified by Kunihiko Ohnaka
// JP:長いブランクが空いてしまったが，Spartan-II E + IO基板でスプライトが
// JP:表示されるようになった．原因はおそらくコンパイラのバグで，ISE 5.2に
// JP:バージョンアップしたら表示されるようになった．
// JP:ついでに，スプライトモード2で横 8枚並ぶようにした(つもり)．
// JP:その他細かな修正が入っています．
// (There was a long blank, but with the Spartan-II E + IO board, the sprites are now displayed.)
// (The cause is probably a compiler bug, and they started to be displayed when I upgraded to ISE 5.2.)
// (By the way, I tried to make 8 sprites line up horizontally in sprite mode 2.)
// (Other minor corrections have been made.)
//
// 15th,July,2002 modified by Kazuhiro Tsujikawa
// no comment;
//
// 5th,September,2019 modified by Oduvaldo Pavan Junior
// Fixed the lack of page flipping (R13) capability
//
// Added the undocumented feature where R1 bit #2 change the blink counter
// clock source from VSYNC to HSYNC
//
//-----------------------------------------------------------------------------
// Document
//
// JP: ESE-VDPのトップエンティティです。CPUとのインターフェース、
// JP: 画面描画タイミングの生成、VDPレジスタの実装などが含まれて
// JP: います。
// Translation:
//   This is the top entity of ESE-VDP. It includes the interface with the CPU,
//   the generation of screen drawing timing, and the implementation of VDP registers.
```
